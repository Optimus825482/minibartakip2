{% extends "base.html" %}

{% block title %}Minibar Kontrol - Minibar Takip Sistemi{% endblock %}
{% block page_title %}Minibar Kontrol{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Kat ve Oda Seçimi -->
    <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
            <h3 class="text-lg leading-6 font-medium text-slate-900 mb-6">Kat ve Oda Seçimi</h3>

            <div class="grid grid-cols-1 gap-6 sm:grid-cols-3">
                <div>
                    <label for="kat_id" class="block text-sm font-medium text-slate-700">
                        Kat <span class="text-red-500">*</span>
                    </label>
                    <div class="mt-1">
                        <select id="kat_id" required
                            class="appearance-none block w-full px-3 py-2 border border-slate-300 rounded-md placeholder-slate-400 focus:outline-none focus:ring-slate-500 focus:border-slate-500 sm:text-sm">
                            <option value="">Kat seçiniz...</option>
                            {% for kat in katlar %}
                            <option value="{{ kat.id }}">{{ kat.kat_adi }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div>
                    <label for="oda_id" class="block text-sm font-medium text-slate-700">
                        Oda <span class="text-red-500">*</span>
                    </label>
                    <div class="mt-1">
                        <select id="oda_id" required disabled
                            class="appearance-none block w-full px-3 py-2 border border-slate-300 rounded-md placeholder-slate-400 focus:outline-none focus:ring-slate-500 focus:border-slate-500 sm:text-sm">
                            <option value="">Önce kat seçiniz...</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label for="islem_tipi" class="block text-sm font-medium text-slate-700">
                        İşlem Tipi <span class="text-red-500">*</span>
                    </label>
                    <div class="mt-1">
                        <select id="islem_tipi" required disabled
                            class="appearance-none block w-full px-3 py-2 border border-slate-300 rounded-md placeholder-slate-400 focus:outline-none focus:ring-slate-500 focus:border-slate-500 sm:text-sm">
                            <option value="">Önce oda seçiniz...</option>
                            <option value="ilk_dolum">İlk Dolum</option>
                            <option value="kontrol">Kontrol</option>
                            <option value="doldurma">Doldurma</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- İlk Dolum Formu -->
    <div id="ilk_dolum_form" class="hidden bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
            <h3 class="text-lg leading-6 font-medium text-slate-900 mb-6">İlk Dolum - Ürün Seçimi</h3>

            <div class="grid grid-cols-1 gap-6 sm:grid-cols-4 mb-4">
                <!-- Ürün Grubu -->
                <div>
                    <label for="urun_grubu" class="block text-sm font-medium text-slate-700">
                        Ürün Grubu <span class="text-red-500">*</span>
                    </label>
                    <div class="mt-1">
                        <select id="urun_grubu"
                            class="appearance-none block w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-slate-500 focus:border-slate-500 sm:text-sm">
                            <option value="">Ürün grubu seçiniz...</option>
                            {% for grup in urun_gruplari %}
                            <option value="{{ grup.id }}">{{ grup.grup_adi }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <!-- Ürün -->
                <div>
                    <label for="urun_secim" class="block text-sm font-medium text-slate-700">
                        Ürün <span class="text-red-500">*</span>
                    </label>
                    <div class="mt-1">
                        <select id="urun_secim" disabled
                            class="appearance-none block w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-slate-500 focus:border-slate-500 sm:text-sm">
                            <option value="">Önce grup seçiniz...</option>
                        </select>
                    </div>
                </div>

                <!-- Miktar -->
                <div>
                    <label for="urun_miktar" class="block text-sm font-medium text-slate-700">
                        Miktar <span class="text-red-500">*</span>
                    </label>
                    <div class="mt-1">
                        <input type="number" id="urun_miktar" min="0" step="0.01" disabled
                            class="appearance-none block w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-slate-500 focus:border-slate-500 sm:text-sm"
                            placeholder="Miktar">
                    </div>
                </div>

                <!-- Ekle Butonu -->
                <div class="flex items-end">
                    <button type="button" id="urun_ekle_btn" disabled
                        class="w-full inline-flex justify-center items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        Listeye Ekle
                    </button>
                </div>
            </div>

            <!-- Zimmet Bilgisi -->
            <div id="zimmet_info" class="hidden mb-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                <p class="text-sm text-blue-800">
                    <span class="font-semibold">Zimmetinizde:</span>
                    <span id="zimmet_miktar_text">-</span>
                </p>
            </div>

            <!-- Seçilen Ürünler -->
            <div id="secilen_urunler_ilk_dolum" class="hidden">
                <h4 class="text-md font-medium text-slate-900 mb-3">Seçilen Ürünler</h4>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-slate-200">
                        <thead class="bg-slate-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">Ürün Adı
                                </th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">Grup</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">Miktar</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">İşlem</th>
                            </tr>
                        </thead>
                        <tbody id="urun_listesi_ilk_dolum" class="bg-white divide-y divide-slate-200">
                        </tbody>
                    </table>
                </div>

                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" onclick="resetForm()"
                        class="inline-flex justify-center py-2 px-4 border border-slate-300 shadow-sm text-sm font-medium rounded-md text-slate-700 bg-white hover:bg-slate-50">
                        İptal
                    </button>
                    <button type="button" id="kaydet_ilk_dolum_btn"
                        class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-slate-600 hover:bg-slate-700">
                        Kaydet
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Kontrol/Doldurma Formu -->
    <div id="kontrol_doldurma_form" class="hidden bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
            <h3 class="text-lg leading-6 font-medium text-slate-900 mb-6">
                <span id="form_baslik">Minibar İçeriği</span>
            </h3>

            <!-- Minibar İçeriği Listesi -->
            <div id="minibar_icerik_container">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-slate-200">
                        <thead class="bg-slate-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">Ürün Adı
                                </th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">Grup</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">Mevcut Stok
                                </th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">Birim</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">İşlem</th>
                            </tr>
                        </thead>
                        <tbody id="minibar_icerik_tbody" class="bg-white divide-y divide-slate-200">
                            <!-- JavaScript ile doldurulacak -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Doldurma Modal -->
<div id="doldurma_modal" class="fixed z-50 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog"
    aria-modal="true">
    <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-slate-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

        <div
            class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div
                        class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 sm:mx-0 sm:h-10 sm:w-10">
                        <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                        <h3 class="text-lg leading-6 font-medium text-slate-900" id="modal_title">
                            Minibar'a Ürün Ekle
                        </h3>
                        <div class="mt-4">
                            <div class="mb-4">
                                <p class="text-sm text-slate-600">
                                    <span class="font-semibold">Ürün:</span> <span id="modal_urun_adi">-</span>
                                </p>
                                <p class="text-sm text-slate-600 mt-1">
                                    <span class="font-semibold">Mevcut Stok:</span> <span
                                        id="modal_mevcut_stok">-</span> <span id="modal_birim">-</span>
                                </p>
                                <p class="text-sm text-slate-600 mt-1">
                                    <span class="font-semibold">Zimmetinizde:</span> <span
                                        id="modal_zimmet_miktar">-</span> <span id="modal_zimmet_birim">-</span>
                                </p>
                            </div>

                            <div>
                                <label for="doldurma_miktar" class="block text-sm font-medium text-slate-700 mb-2">
                                    Eklenecek Miktar <span class="text-red-500">*</span>
                                </label>
                                <input type="number" id="doldurma_miktar" min="0" step="0.01"
                                    class="appearance-none block w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                    placeholder="Miktar giriniz">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-slate-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" id="modal_onayla_btn"
                    class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
                    Onayla ve Ekle
                </button>
                <button type="button" onclick="closeModal()"
                    class="mt-3 w-full inline-flex justify-center rounded-md border border-slate-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-slate-700 hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                    İptal
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    let secilenOdaId = null;
    let secilenIslemTipi = null;
    let ilkDolumUrunler = [];
    let mevcutZimmetler = {};
    let aktifUrunId = null;
    let aktifUrunBilgi = null;

    // Kat değiştiğinde
    document.getElementById( 'kat_id' ).addEventListener( 'change', async function () {
        const katId = this.value;
        const odaSelect = document.getElementById( 'oda_id' );
        const islemTipiSelect = document.getElementById( 'islem_tipi' );

        odaSelect.innerHTML = '<option value="">Oda seçiniz...</option>';
        odaSelect.disabled = true;
        islemTipiSelect.disabled = true;
        islemTipiSelect.value = '';
        resetForm();

        if ( !katId ) return;

        try {
            const response = await fetch( `/kat-odalari?kat_id=${katId}` );
            const data = await response.json();

            if ( data.success && data.odalar.length > 0 ) {
                data.odalar.forEach( oda => {
                    const option = document.createElement( 'option' );
                    option.value = oda.id;
                    option.textContent = oda.oda_no;
                    odaSelect.appendChild( option );
                } );
                odaSelect.disabled = false;
            } else {
                odaSelect.innerHTML = '<option value="">Bu katta oda yok</option>';
            }
        } catch ( error ) {
            console.error( 'Hata:', error );
            alert( 'Odalar yüklenirken bir hata oluştu!' );
        }
    } );

    // Oda değiştiğinde
    document.getElementById( 'oda_id' ).addEventListener( 'change', function () {
        const odaId = this.value;
        const islemTipiSelect = document.getElementById( 'islem_tipi' );

        if ( odaId ) {
            secilenOdaId = odaId;
            islemTipiSelect.disabled = false;
        } else {
            secilenOdaId = null;
            islemTipiSelect.disabled = true;
            islemTipiSelect.value = '';
            resetForm();
        }
    } );

    // İşlem tipi değiştiğinde
    document.getElementById( 'islem_tipi' ).addEventListener( 'change', async function () {
        const islemTipi = this.value;
        secilenIslemTipi = islemTipi;
        resetForm();

        if ( !islemTipi || !secilenOdaId ) return;

        // Zimmet bilgilerini yükle
        await loadZimmetBilgileri();

        if ( islemTipi === 'ilk_dolum' ) {
            document.getElementById( 'ilk_dolum_form' ).classList.remove( 'hidden' );
        } else if ( islemTipi === 'kontrol' || islemTipi === 'doldurma' ) {
            document.getElementById( 'form_baslik' ).textContent =
                islemTipi === 'kontrol' ? 'Minibar Kontrolü' : 'Minibar Doldurma';
            await loadMinibarIcerigi( secilenOdaId );
            document.getElementById( 'kontrol_doldurma_form' ).classList.remove( 'hidden' );
        }
    } );

    // Zimmet bilgilerini yükle
    async function loadZimmetBilgileri() {
        try {
            const response = await fetch( '/api/zimmetim' );
            const zimmetler = await response.json();

            mevcutZimmetler = {};
            zimmetler.forEach( z => {
                mevcutZimmetler[z.urun_id] = {
                    kalan: z.kalan_miktar,
                    toplam: z.toplam_miktar,
                    birim: z.birim,
                    urun_adi: z.urun_adi
                };
            } );
        } catch ( error ) {
            console.error( 'Zimmet bilgileri yüklenirken hata:', error );
        }
    }

    // Minibar içeriğini yükle
    async function loadMinibarIcerigi( odaId ) {
        try {
            const response = await fetch( `/api/minibar-icerigi/${odaId}` );
            const data = await response.json();

            if ( data.success ) {
                const tbody = document.getElementById( 'minibar_icerik_tbody' );
                tbody.innerHTML = '';

                if ( data.urunler.length === 0 ) {
                    tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-slate-500">Bu odada henüz minibar dolumu yapılmamış</td></tr>';
                    return;
                }

                data.urunler.forEach( urun => {
                    const tr = document.createElement( 'tr' );
                    tr.className = 'hover:bg-slate-50';
                    tr.innerHTML = `
                        <td class="px-4 py-3 text-sm text-slate-900">${urun.urun_adi}</td>
                        <td class="px-4 py-3 text-sm text-slate-600">${urun.grup_adi}</td>
                        <td class="px-4 py-3 text-sm text-slate-900 font-medium">${urun.mevcut_stok}</td>
                        <td class="px-4 py-3 text-sm text-slate-600">${urun.birim}</td>
                        <td class="px-4 py-3 text-sm">
                            ${secilenIslemTipi === 'doldurma' ? `
                                <button type="button" onclick="openDoldurmaModal(${urun.urun_id}, '${urun.urun_adi}', ${urun.mevcut_stok}, '${urun.birim}')"
                                    class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                    </svg>
                                    Ekle
                                </button>
                            ` : '<span class="text-slate-400 text-xs">Kontrol Modu</span>'}
                        </td>
                    `;
                    tbody.appendChild( tr );
                } );
            }
        } catch ( error ) {
            console.error( 'Minibar içeriği yüklenirken hata:', error );
            alert( 'Minibar içeriği yüklenirken bir hata oluştu!' );
        }
    }

    // Doldurma modalını aç
    function openDoldurmaModal( urunId, urunAdi, mevcutStok, birim ) {
        aktifUrunId = urunId;
        aktifUrunBilgi = { urunAdi, mevcutStok, birim };

        document.getElementById( 'modal_urun_adi' ).textContent = urunAdi;
        document.getElementById( 'modal_mevcut_stok' ).textContent = mevcutStok;
        document.getElementById( 'modal_birim' ).textContent = birim;

        const zimmet = mevcutZimmetler[urunId];
        if ( zimmet ) {
            document.getElementById( 'modal_zimmet_miktar' ).textContent = zimmet.kalan;
            document.getElementById( 'modal_zimmet_birim' ).textContent = zimmet.birim;
        } else {
            document.getElementById( 'modal_zimmet_miktar' ).textContent = '0';
            document.getElementById( 'modal_zimmet_birim' ).textContent = birim;
        }

        document.getElementById( 'doldurma_miktar' ).value = '';
        document.getElementById( 'doldurma_modal' ).classList.remove( 'hidden' );
    }

    // Modal kapat
    function closeModal() {
        document.getElementById( 'doldurma_modal' ).classList.add( 'hidden' );
        aktifUrunId = null;
        aktifUrunBilgi = null;
    }

    // Modal onay
    document.getElementById( 'modal_onayla_btn' ).addEventListener( 'click', async function () {
        const miktar = parseFloat( document.getElementById( 'doldurma_miktar' ).value );

        if ( !miktar || miktar <= 0 ) {
            alert( 'Lütfen geçerli bir miktar giriniz!' );
            return;
        }

        const zimmet = mevcutZimmetler[aktifUrunId];
        if ( !zimmet || zimmet.kalan < miktar ) {
            alert( `Yetersiz zimmet! Zimmetinizde kalan: ${zimmet ? zimmet.kalan : 0} ${aktifUrunBilgi.birim}` );
            return;
        }

        // Onay mesajı
        const onay = confirm(
            `${miktar} ${aktifUrunBilgi.birim} ${aktifUrunBilgi.urunAdi} minibar'a eklenecek.\n\n` +
            `Bu işlem sonucunda:\n` +
            `• ${miktar} ${aktifUrunBilgi.birim} ürün minibar'a eklenecek\n` +
            `• Zimmetinizden ${miktar} ${aktifUrunBilgi.birim} düşülecek\n` +
            `• Tüketim olarak kaydedilecek\n\n` +
            `Onaylıyor musunuz?`
        );

        if ( !onay ) return;

        // API'ye gönder
        try {
            const response = await fetch( '/api/minibar-doldur', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify( {
                    oda_id: secilenOdaId,
                    urun_id: aktifUrunId,
                    miktar: miktar,
                    islem_tipi: secilenIslemTipi
                } )
            } );

            const data = await response.json();

            if ( data.success ) {
                alert( data.message );
                closeModal();
                // Listeyi yeniden yükle
                await loadMinibarIcerigi( secilenOdaId );
                // Zimmet bilgilerini yeniden yükle
                await loadZimmetBilgileri();
            } else {
                alert( 'Hata: ' + data.error );
            }
        } catch ( error ) {
            console.error( 'Hata:', error );
            alert( 'İşlem sırasında bir hata oluştu!' );
        }
    } );

    // İlk dolum için ürün grubu değişimi
    document.getElementById( 'urun_grubu' ).addEventListener( 'change', async function () {
        const grupId = this.value;
        const urunSelect = document.getElementById( 'urun_secim' );
        const miktarInput = document.getElementById( 'urun_miktar' );

        urunSelect.innerHTML = '<option value="">Ürün seçiniz...</option>';
        urunSelect.disabled = true;
        miktarInput.disabled = true;
        miktarInput.value = '';
        document.getElementById( 'zimmet_info' ).classList.add( 'hidden' );
        document.getElementById( 'urun_ekle_btn' ).disabled = true;

        if ( !grupId ) return;

        try {
            const response = await fetch( `/api/urunler-by-grup/${grupId}` );
            const urunler = await response.json();

            if ( urunler.length === 0 ) {
                urunSelect.innerHTML = '<option value="">Bu grupta ürün yok</option>';
            } else {
                urunler.forEach( urun => {
                    const option = document.createElement( 'option' );
                    option.value = urun.id;
                    option.textContent = urun.urun_adi;
                    urunSelect.appendChild( option );
                } );
                urunSelect.disabled = false;
            }
        } catch ( error ) {
            console.error( 'Hata:', error );
            alert( 'Ürünler yüklenirken bir hata oluştu!' );
        }
    } );

    // İlk dolum için ürün seçimi
    document.getElementById( 'urun_secim' ).addEventListener( 'change', function () {
        const urunId = this.value;
        const miktarInput = document.getElementById( 'urun_miktar' );
        const zimmetInfo = document.getElementById( 'zimmet_info' );

        if ( !urunId ) {
            miktarInput.disabled = true;
            zimmetInfo.classList.add( 'hidden' );
            return;
        }

        const zimmet = mevcutZimmetler[urunId];
        if ( zimmet ) {
            document.getElementById( 'zimmet_miktar_text' ).textContent =
                `${zimmet.kalan} ${zimmet.birim} (Toplam: ${zimmet.toplam} ${zimmet.birim})`;
            zimmetInfo.classList.remove( 'hidden' );
        } else {
            document.getElementById( 'zimmet_miktar_text' ).textContent = 'Zimmetinizde yok';
            zimmetInfo.classList.remove( 'hidden' );
        }

        miktarInput.disabled = false;
        miktarInput.focus();
    } );

    // Miktar değişimi
    document.getElementById( 'urun_miktar' ).addEventListener( 'input', function () {
        const miktar = parseFloat( this.value );
        const ekleBtn = document.getElementById( 'urun_ekle_btn' );
        ekleBtn.disabled = !( miktar > 0 );
    } );

    // İlk dolum için listeye ekle
    document.getElementById( 'urun_ekle_btn' ).addEventListener( 'click', function () {
        const urunId = document.getElementById( 'urun_secim' ).value;
        const urunAdi = document.getElementById( 'urun_secim' ).options[document.getElementById( 'urun_secim' ).selectedIndex].text;
        const grupAdi = document.getElementById( 'urun_grubu' ).options[document.getElementById( 'urun_grubu' ).selectedIndex].text;
        const miktar = parseFloat( document.getElementById( 'urun_miktar' ).value );

        if ( !urunId || !miktar || miktar <= 0 ) return;

        // Zimmet kontrolü
        const zimmet = mevcutZimmetler[urunId];
        if ( !zimmet || zimmet.kalan < miktar ) {
            alert( `Yetersiz zimmet! Zimmetinizde kalan: ${zimmet ? zimmet.kalan : 0} ${zimmet ? zimmet.birim : ''}` );
            return;
        }

        // Aynı ürün var mı kontrol et
        const mevcutIndex = ilkDolumUrunler.findIndex( u => u.id == urunId );
        if ( mevcutIndex !== -1 ) {
            ilkDolumUrunler[mevcutIndex].miktar = miktar;
        } else {
            ilkDolumUrunler.push( {
                id: urunId,
                urunAdi: urunAdi,
                grupAdi: grupAdi,
                miktar: miktar,
                birim: zimmet.birim
            } );
        }

        updateIlkDolumListesi();

        // Formu sıfırla
        document.getElementById( 'urun_grubu' ).value = '';
        document.getElementById( 'urun_secim' ).innerHTML = '<option value="">Önce grup seçiniz...</option>';
        document.getElementById( 'urun_secim' ).disabled = true;
        document.getElementById( 'urun_miktar' ).value = '';
        document.getElementById( 'urun_miktar' ).disabled = true;
        document.getElementById( 'zimmet_info' ).classList.add( 'hidden' );
        document.getElementById( 'urun_ekle_btn' ).disabled = true;
    } );

    // İlk dolum listesini güncelle
    function updateIlkDolumListesi() {
        const tbody = document.getElementById( 'urun_listesi_ilk_dolum' );
        const container = document.getElementById( 'secilen_urunler_ilk_dolum' );

        tbody.innerHTML = '';

        if ( ilkDolumUrunler.length === 0 ) {
            container.classList.add( 'hidden' );
            return;
        }

        container.classList.remove( 'hidden' );

        ilkDolumUrunler.forEach( ( urun, index ) => {
            const tr = document.createElement( 'tr' );
            tr.innerHTML = `
                <td class="px-4 py-3 text-sm text-slate-900">${urun.urunAdi}</td>
                <td class="px-4 py-3 text-sm text-slate-600">${urun.grupAdi}</td>
                <td class="px-4 py-3 text-sm text-slate-900 font-medium">${urun.miktar} ${urun.birim}</td>
                <td class="px-4 py-3 text-sm">
                    <button type="button" onclick="removeIlkDolumUrun(${index})"
                        class="text-red-600 hover:text-red-900">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                    </button>
                </td>
            `;
            tbody.appendChild( tr );
        } );
    }

    // İlk dolum ürün çıkar
    function removeIlkDolumUrun( index ) {
        ilkDolumUrunler.splice( index, 1 );
        updateIlkDolumListesi();
    }

    // İlk dolum kaydet
    document.getElementById( 'kaydet_ilk_dolum_btn' ).addEventListener( 'click', async function () {
        if ( ilkDolumUrunler.length === 0 ) {
            alert( 'Lütfen en az bir ürün ekleyiniz!' );
            return;
        }

        const formData = new FormData();
        formData.append( 'oda_id', secilenOdaId );
        formData.append( 'islem_tipi', 'ilk_dolum' );
        formData.append( 'aciklama', 'İlk dolum' );

        ilkDolumUrunler.forEach( urun => {
            formData.append( `miktar_${urun.id}`, urun.miktar );
        } );

        try {
            const response = await fetch( '/minibar-kontrol', {
                method: 'POST',
                body: formData
            } );

            if ( response.ok ) {
                alert( 'İlk dolum başarıyla kaydedildi!' );
                resetForm();
                window.location.reload();
            } else {
                alert( 'İşlem sırasında bir hata oluştu!' );
            }
        } catch ( error ) {
            console.error( 'Hata:', error );
            alert( 'İşlem sırasında bir hata oluştu!' );
        }
    } );

    // Formu sıfırla
    function resetForm() {
        document.getElementById( 'ilk_dolum_form' ).classList.add( 'hidden' );
        document.getElementById( 'kontrol_doldurma_form' ).classList.add( 'hidden' );
        ilkDolumUrunler = [];
        updateIlkDolumListesi();
    }
</script>
{% endblock %}